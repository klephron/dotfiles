#!/usr/bin/env bash

wrapped_file=
encrypted_dir=
mount_point=
sig=
use_wrapped=0

usage() {
  echo "Usage: $0 [-w <wrapped-passphrase-file>] <encrypted-dir> <mount-point>" >&2
  exit 1
}

while getopts ":w:" opt; do
  case $opt in
    w)
      wrapped_file="$OPTARG"
      use_wrapped=1
      ;;
    *)
      usage
      ;;
  esac
done

shift $((OPTIND - 1))

encrypted_dir="$1"
mount_point="$2"

if [[ -z "$encrypted_dir" ]] || [[ -z "$mount_point" ]]; then
  usage
fi

if [ ! -d "$encrypted_dir" ]; then
  mkdir -p "$encrypted_dir" || {
    echo "Error: Cannot create encrypted directory: $encrypted_dir" >&2
    exit 1
  }
fi

if [ ! -d "$mount_point" ]; then
  mkdir -p "$mount_point" || {
    echo "Error: Cannot create mount point: $mount_point" >&2
    exit 1
  }
fi

if (( use_wrapped )); then
  sig=$(ecrfs-add -w "$wrapped_file")
else
  sig=$(ecrfs-add)
fi

if [[ -z "$sig" ]]; then
  exit 1
fi

mount -i -t ecryptfs "$encrypted_dir" "$mount_point" \
  -o "ecryptfs_sig=$sig,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs"
