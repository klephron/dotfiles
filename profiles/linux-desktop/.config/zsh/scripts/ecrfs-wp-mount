#!/usr/bin/env bash

local wrapped_file="$1"
local encrypted_dir="$2"
local mount_point="$3"
local sig

if [[ -z "$wrapped_file" ]] || [[ -z "$encrypted_dir" ]] || [[ -z "$mount_point" ]]; then
  echo "Usage: $0 <wrapped-passphrase-file> <encrypted-dir> <mount-point>" >&2
  return 1
fi

if [ ! -f "$wrapped_file" ]; then
  echo "Error: Wrapped passphrase file not found: $wrapped_file" >&2
  exit 1
fi

if [ ! -d "$encrypted_dir" ]; then
  mkdir -p "$encrypted_dir" || {
    echo "Error: Cannot create encrypted directory: $encrypted_dir" >&2
    return 1
  }
fi

if [ ! -d "$mount_point" ]; then
  mkdir -p "$mount_point" || {
    echo "Error: Cannot create mount point: $mount_point" >&2
    return 1
  }
fi

sig=$(ecrfs-wp-ins "$wrapped_file")

if [[ -z "$sig" ]]; then
  return 1
fi

mount -i -t ecryptfs "$encrypted_dir" "$mount_point" \
  -o "ecryptfs_sig=$sig,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs"
